<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Challan | WorkshopSys</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #f4f4f4;
      padding: 30px;
    }
    .upload-box {
      border: 2px dashed #ccc;
      border-radius: 8px;
      text-align: center;
      padding: 40px 20px;
      cursor: pointer;
      transition: 0.3s ease;
    }
    .upload-box:hover {
      border-color: #007bff;
    }
    .upload-box i {
      font-size: 48px;
      color: #007bff;
    }
    .tab-btn {
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    #ocrStatus {
        margin-top: 15px;
        font-weight: bold;
        color: #007bff;
    }
    #extractedTextDisplay {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: #ffffff;
        text-align: left;
        white-space: pre-wrap; /* Preserves whitespace and line breaks */
        font-family: monospace; /* Helps in viewing raw text */
        max-height: 300px;
        overflow-y: auto;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="mb-4">Add Challan</h2>

  <ul class="nav nav-tabs" id="challanTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active tab-btn" id="auto-tab" data-bs-toggle="tab" data-bs-target="#automated" type="button" role="tab">Automated</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link tab-btn" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">Manual</button>
    </li>
  </ul>

  <div class="tab-content" id="challanTabContent">

    <div class="tab-pane fade show active mt-4" id="automated" role="tabpanel">
      <div class="upload-box" onclick="toggleUploadOptions()">
        <i class="bi bi-plus-circle"></i><br>
        <strong>Click to Take Photo or Upload Image</strong>
        <p class="text-muted">Supported: JPG, PNG | Max size: 5MB</p>
      </div>

      <div id="uploadOptions" class="mt-3 d-none text-center">
        <button class="btn btn-outline-primary me-2" onclick="openCamera()">üì∑ Take Photo</button>
        <input type="file" accept="image/*" id="fileInput" hidden onchange="previewImage(event)">
        <button class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()">üìÅ Upload from Gallery</button>
      </div>

      <div id="preview" class="mt-4 text-center"></div>
      <div id="ocrStatus" class="text-center"></div>
      <div id="extractedTextDisplay" class="d-none">
        <h6>Extracted Text:</h6>
        <pre id="rawOcrText"></pre>
      </div>
    </div>


    <div class="tab-pane fade mt-4" id="manual" role="tabpanel">
  <form id="manualChallanForm">
    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="companyName">Company Name</label>
        <input type="text" class="form-control" id="companyName" name="companyName" placeholder="Type or select receiver company" required list="receiverCompaniesDatalist">
        <datalist id="receiverCompaniesDatalist"></datalist>
      </div>
      <div class="col-md-6 mb-3">
        <label for="gstNumber">GST Number</label>
        <input type="text" class="form-control" id="gstNumber" name="gstNumber" placeholder="Enter GST or auto-fill">
      </div>
      <div class="col-md-12 mb-3">
        <label for="address">Address</label>
        <input type="text" class="form-control" id="address" name="address" placeholder="Enter receiver address">
      </div>
      <div class="col-md-6 mb-3">
        <label for="phone">Phone</label>
        <input type="text" class="form-control" id="phone" name="phone" placeholder="Enter receiver phone number">
      </div>
      <div class="col-md-6 mb-3">
        <label for="email">Email</label>
        <input type="email" class="form-control" id="email" name="email" placeholder="Enter receiver email">
      </div>
      <div class="col-md-6 mb-3">
        <label>Challan Date</label>
        <input type="date" class="form-control" id="challanDate" name="challanDate" value="2025-07-27" required>
      </div>
      <div class="col-md-6 mb-3">
        <label>Challan Number</label>
        <input type="text" class="form-control" id="challanNumber" name="challanNumber" placeholder="181" required>
      </div>
    </div>

    <hr class="my-4" />
    <h5>Product Details</h5>

    <div id="productContainer">
      <div class="product-row row mb-3 border p-3 rounded">
        <div class="col-md-4">
          <label>Description</label>
          <input type="text" class="form-control" name="description[]" placeholder="PIN A-PILLAR ASSY .ROLLING" required>
        </div>
        <div class="col-md-2">
          <label>HSN Code</label>
          <input type="text" class="form-control" name="hsn[]" placeholder="87081090" required>
        </div>
        <div class="col-md-2">
          <label>Quantity</label>
          <input type="number" class="form-control" name="quantity[]" placeholder="3995" required>
        </div>
        <div class="col-md-2">
          <label>Unit</label>
          <input type="text" class="form-control" name="unit[]" placeholder="Nos / pcs" required>
        </div>
        <div class="col-md-2">
          <label>Process</label>
          <div class="input-group">
            <input type="text" class="form-control" name="process[]" placeholder="ROLLING" required>
            <button type="button" class="btn btn-outline-danger" onclick="removeProductRow(this)">√ó</button>
          </div>
        </div>
      </div>
    </div>

    <button type="button" class="btn btn-outline-primary" onclick="addProductRow()">+ Add Product</button>

    <div class="mt-4">
      <button class="btn btn-success" type="submit">Save Challan</button>
    </div>
  </form>
</div>
  </div>
</div>

<div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content p-3 text-center">
      <div class="modal-header">
        <h5 class="modal-title">Take a Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="stopCamera()"></button>
      </div>
      <div class="modal-body">
        <video id="video" autoplay playsinline class="w-100 rounded border" style="max-height: 400px;"></video>
        <button class="btn btn-success mt-3" onclick="capturePhoto()">üì∏ Capture</button>
        <canvas id="canvas" class="d-none"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js'></script>

<script>
  let stream;
  let worker; // Tesseract.js worker

  // Initialize Tesseract worker
  async function initializeTesseract() {
    document.getElementById('ocrStatus').innerText = 'Loading OCR engine...';
    worker = await Tesseract.createWorker('eng', 1, {
        logger: m => {
            if (m.status === 'recognizing text') {
                document.getElementById('ocrStatus').innerText = `OCR Progress: ${Math.round(m.progress * 100)}%`;
            } else {
                document.getElementById('ocrStatus').innerText = `OCR Status: ${m.status}`;
            }
        }
    });
    document.getElementById('ocrStatus').innerText = 'OCR engine loaded.';
  }

  // Call this when the page loads
  document.addEventListener('DOMContentLoaded', initializeTesseract);
// ... (Your existing JavaScript, like initializeTesseract, toggleUploadOptions, previewImage, etc.) ...

let availableReceivers = []; // This array will store all fetched receiver data

document.addEventListener('DOMContentLoaded', function() {
    initializeTesseract(); // Keep your OCR initialization
    addProductRow(); // Keep this if you want one product row initially

    loadReceiversForDatalist(); // Call this function to populate the datalist on page load
    
    // Add an event listener to the companyName input for auto-filling GST
    document.getElementById('companyName').addEventListener('input', populateGstNumber);
});

async function loadReceiversForDatalist() {
    const datalistElement = document.getElementById('receiverCompaniesDatalist');
    datalistElement.innerHTML = ''; // Clear existing options in the datalist

    try {
        const response = await fetch('/get_receivers'); // Fetch filtered receivers from your Flask app
        const data = await response.json();

        if (response.ok && data.receivers) {
            availableReceivers = data.receivers; // Store the fetched data for later use (e.g., getting GST)
            data.receivers.forEach(receiver => {
                const option = document.createElement('option');
                option.value = receiver.company_name; // The value of the option will be the company name
                // Optionally, store GST number in a data attribute for easier lookup, though 'find' works too
                option.dataset.gst = receiver.gst_number; 
                datalistElement.appendChild(option);
            });
        } else {
            console.error('Error loading receivers:', data.message || 'Unknown error');
        }
    } catch (error) {
        console.error('Fetch error for receivers:', error);
    }
}

function populateGstNumber() {
    const companyNameInput = document.getElementById('companyName');
    const gstNumberInput = document.getElementById('gstNumber');
    const enteredCompanyName = companyNameInput.value.trim();

    // Find if the entered company name matches an existing receiver (case-insensitive)
    const matchedReceiver = availableReceivers.find(r => r.company_name.toLowerCase() === enteredCompanyName.toLowerCase());

    if (matchedReceiver) {
        gstNumberInput.value = matchedReceiver.gst_number || ''; // Populate GST field
    } else {
        // If no match found, it's either a new receiver or a partial entry.
        // Clear the GST field so the user can enter it manually for a new receiver.
        gstNumberInput.value = ''; 
    }
}

// ... (Your existing JavaScript functions like addProductRow, removeProductRow, etc.) ...

// Ensure your form submission logic is correct (no major changes needed here)
// document.getElementById('manualChallanForm').addEventListener('submit', async function(event) {
//     event.preventDefault(); // Prevent default form submission

//     const formData = new FormData(this);
//     const data = {};

//     // Collect main fields from the input fields
//     data.companyName = formData.get('companyName'); // Gets value from the text input
//     data.gstNumber = formData.get('gstNumber');     // Gets value from the (now editable) GST input
//     data.challanDate = formData.get('challanDate');
//     data.challanNumber = formData.get('challanNumber');

//     // ... (rest of your product details collection logic - no change needed here) ...
//     data.products = [];
//     const descriptions = formData.getAll('description[]');
//     const hsns = formData.getAll('hsn[]');
//     const quantities = formData.getAll('quantity[]');
//     const units = formData.getAll('unit[]');
//     const processes = formData.getAll('process[]');

//     for (let i = 0; i < descriptions.length; i++) {
//         data.products.push({
//             description: descriptions[i],
//             hsn: hsns[i],
//             quantity: quantities[i],
//             unit: units[i],
//             process: processes[i]
//         });
//     }

//     try {
//         const response = await fetch('/save_challan', {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json'
//             },
//             body: JSON.stringify(data)
//         });

//         const result = await response.json();
//         if (response.ok) {
//             alert(result.message);
//             this.reset(); // Clear the form
//             document.getElementById('productContainer').innerHTML = ''; // Clear product rows
//             addProductRow(); // Add a new empty product row
//             loadReceiversForDatalist(); // IMPORTANT: Reload the datalist to include any newly added receiver
//         } else {
//             alert('Error: ' + result.message);
//         }
//     } catch (error) {
//         console.error('Fetch error:', error);
//         alert('An unexpected error occurred while saving the challan.');
//     }
// });
document.getElementById('manualChallanForm').addEventListener('submit', async function(event) {
    event.preventDefault(); // <-- Ensure this is the very first line

    const submitButton = document.querySelector('#manualChallanForm button[type="submit"]'); // Get your submit button
    if (submitButton) {
        submitButton.disabled = true; // Disable button to prevent double clicks
        submitButton.textContent = 'Saving...'; // Optional: Give feedback
    }

    const formData = new FormData(this);
    const data = {};

    // ... (rest of your form data collection) ...

    try {
        const response = await fetch('/save_challan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            this.reset();
            document.getElementById('productContainer').innerHTML = '';
            addProductRow();
            loadReceiversForDatalist();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Fetch error:', error);
        alert('An unexpected error occurred while saving the challan.');
    } finally {
        // Re-enable the button regardless of success or failure
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Save Challan'; // Reset button text
        }
    }
});

  function toggleUploadOptions() {
    const options = document.getElementById('uploadOptions');
    options.classList.toggle('d-none');
  }

  async function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
      const preview = document.getElementById('preview');
      preview.innerHTML = `
        <h6 class="text-success">Uploaded Image:</h6>
        <img id="uploadedImagePreview" src="${URL.createObjectURL(file)}" class="img-fluid mt-2 border rounded" style="max-width: 400px;">
      `;
      document.getElementById('extractedTextDisplay').classList.add('d-none'); // Hide previous text
      await processImageWithOCR(file);
    }
  }

  function openCamera() {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(function(mediaStream) {
        stream = mediaStream;
        const video = document.getElementById('video');
        video.srcObject = stream;
        video.play();
        new bootstrap.Modal(document.getElementById('cameraModal')).show();
      })
      .catch(function(err) {
        alert("Camera Error: " + err.message);
      });
  }

  function stopCamera() {
    const video = document.getElementById('video');
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    video.srcObject = null;
  }

  async function capturePhoto() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageDataURL = canvas.toDataURL('image/png');
    preview.innerHTML = `
      <h6 class="text-success">Captured Image:</h6>
      <img src="${imageDataURL}" class="img-fluid mt-2 border rounded" style="max-width: 400px;">
    `;

    bootstrap.Modal.getInstance(document.getElementById('cameraModal')).hide();
    stopCamera();

    document.getElementById('extractedTextDisplay').classList.add('d-none'); // Hide previous text
    await processImageWithOCR(imageDataURL);
  }

  async function processImageWithOCR(image) {
    if (!worker) {
        document.getElementById('ocrStatus').innerText = 'OCR engine not loaded. Please wait or refresh.';
        return;
    }

    document.getElementById('ocrStatus').innerText = 'Starting OCR processing...';
    document.getElementById('extractedTextDisplay').classList.add('d-none'); // Hide until new text is ready
    document.getElementById('rawOcrText').innerText = ''; // Clear previous text

    try {
        const { data: { text } } = await worker.recognize(image);
        document.getElementById('ocrStatus').innerText = 'OCR complete!';
        console.log('OCR Result Text:', text); // Log to console for debugging

        // Display the extracted text below the image
        document.getElementById('rawOcrText').innerText = text;
        document.getElementById('extractedTextDisplay').classList.remove('d-none');

        // Automatically switch to Manual tab after OCR
        var manualTab = new bootstrap.Tab(document.getElementById('manual-tab'));
        manualTab.show();

        // Attempt to parse the extracted text and populate fields (Still needs refinement)
        populateManualForm(text);

    } catch (error) {
        console.error('OCR Error:', error);
        document.getElementById('ocrStatus').innerText = 'OCR failed! Error: ' + error.message;
        document.getElementById('rawOcrText').innerText = 'Error during OCR: ' + error.message;
        document.getElementById('extractedTextDisplay').classList.remove('d-none');
        alert('OCR failed. Please enter details manually.');
        var manualTab = new bootstrap.Tab(document.getElementById('manual-tab'));
        manualTab.show();
    }
  }


  function populateManualForm(ocrText) {
    // --- IMPORTANT: This parsing logic is highly dependent on your challan's layout ---
    // You will need to customize these regular expressions and logic
    // based on the actual text output you get from Tesseract.js for YOUR challans.

    // Example parsing for common fields (Highly simplified)
    const companyNameInput = document.getElementById('companyName');
    const gstNumberInput = document.getElementById('gstNumber');
    const challanDateInput = document.getElementById('challanDate');
    const challanNumberInput = document.getElementById('challanNumber');
    const productContainer = document.getElementById('productContainer');

    // Reset fields
    companyNameInput.value = '';
    gstNumberInput.value = '';
    challanDateInput.value = '';
    challanNumberInput.value = '';
    productContainer.innerHTML = ''; // Clear existing products

    // Example 1: Extract GST Number (Indian GST format)
    const gstMatch = ocrText.match(/\b\d{2}[A-Z]{5}\d{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}\b/i);
    if (gstMatch) {
      gstNumberInput.value = gstMatch[0];
    }

    // Example 2: Extract Challan Number (assuming it's 'CHALLAN NO: XXX' or similar)
    const challanNoMatch = ocrText.match(/(?:CHALLAN\s*NO[.:]?\s*)(\d+)/i);
    if (challanNoMatch && challanNoMatch[1]) {
      challanNumberInput.value = challanNoMatch[1];
    }

    // Example 3: Extract Date (various date formats)
    const dateMatch = ocrText.match(/\b(\d{1,2}[./-]\d{1,2}[./-]\d{2,4}|\d{4}[./-]\d{1,2}[./-]\d{1,2})\b/);
    if (dateMatch) {
        let dateStr = dateMatch[0];
        // Attempt to reformat to YYYY-MM-DD for date input
        let parts = dateStr.split(/[\/\.-]/);
        if (parts.length === 3) {
            let year = parts[2].length === 2 ? `20${parts[2]}` : parts[2];
            let month = parts[1].padStart(2, '0');
            let day = parts[0].padStart(2, '0');
            // Check if it's DD/MM/YYYY or MM/DD/YYYY
            // This is a common heuristic, may need adjustment
            if (parseInt(month) > 12 && parseInt(day) <= 12) { // Likely DD/MM
                [day, month] = [month, day]; // Swap them
            }
            challanDateInput.value = `${year}-${month}-${day}`;
        }
    }


    // Example 4: Extract Company Name (very hard without specific heuristics)
    // This is the trickiest part as company name can be anywhere.
    // You might need to look for specific keywords or positions on your challan layout.
    // For a simple demo, let's just show the first few lines as potential company name.
    const lines = ocrText.split('\n').filter(line => line.trim() !== '');
    if (lines.length > 0) {
        // This is a placeholder. You'll need more sophisticated logic
        // E.g., looking for "To:", "M/s:", or based on position.
        // companyNameInput.value = lines[0]; // Could be any header
    }

    // Add at least one product row if no products are extracted, or always
    // You'd typically only call addProductRow() for each product extracted.
    if (productContainer.children.length === 0) {
        addProductRow();
    }
  }


  function addProductRow() {
    const productContainer = document.getElementById('productContainer');
    const productRow = document.createElement('div');
    productRow.classList.add('product-row', 'row', 'mb-3', 'border', 'p-3', 'rounded');

    productRow.innerHTML = `
      <div class="col-md-4">
        <label>Description</label>
        <input type="text" class="form-control" name="description[]" required>
      </div>
      <div class="col-md-2">
        <label>HSN Code</label>
        <input type="text" class="form-control" name="hsn[]" required>
      </div>
      <div class="col-md-2">
        <label>Quantity</label>
        <input type="number" class="form-control" name="quantity[]" required>
      </div>
      <div class="col-md-2">
        <label>Unit</label>
        <input type="text" class="form-control" name="unit[]" required>
      </div>
      <div class="col-md-2">
        <label>Process</label>
        <div class="input-group">
          <input type="text" class="form-control" name="process[]" required>
          <button type="button" class="btn btn-outline-danger" onclick="removeProductRow(this)">√ó</button>
        </div>
      </div>
    `;

    productContainer.appendChild(productRow);
  }

  function removeProductRow(button) {
    button.closest('.product-row').remove();
  }

  // New JavaScript to handle form submission
  document.getElementById('manualChallanForm').addEventListener('submit', async function(event) {
    event.preventDefault(); // Prevent default form submission

    const formData = new FormData(this);
    // const data = {};

    // // Collect main fields
    // data.companyName = formData.get('companyName');
    // data.gstNumber = formData.get('gstNumber');
    // data.challanDate = formData.get('challanDate');
    // data.challanNumber = formData.get('challanNumber');
    const data = {};

    // Collect main fields
    data.companyName = formData.get('companyName');
    data.gstNumber = formData.get('gstNumber');
    // NEW: Collect address, phone, email
    data.address = formData.get('address');
    data.phone = formData.get('phone');
    data.email = formData.get('email');

    data.challanDate = formData.get('challanDate');
    data.challanNumber = formData.get('challanNumber');

    // Collect product details
    data.products = [];
    const descriptions = formData.getAll('description[]');
    const hsns = formData.getAll('hsn[]');
    const quantities = formData.getAll('quantity[]');
    const units = formData.getAll('unit[]');
    const processes = formData.getAll('process[]');

    for (let i = 0; i < descriptions.length; i++) {
        data.products.push({
            description: descriptions[i],
            hsn: hsns[i],
            quantity: quantities[i],
            unit: units[i],
            process: processes[i]
        });
    }

    try {
        const response = await fetch('/save_challan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            // Optionally, clear form or redirect
            this.reset(); // Clear the form
            document.getElementById('productContainer').innerHTML = ''; // Clear product rows
            addProductRow(); // Add a new empty product row
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Fetch error:', error);
        alert('An unexpected error occurred while saving the challan.');
    }
  });
</script>

</body>
</html>